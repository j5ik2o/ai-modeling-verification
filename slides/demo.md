---
theme: default
layout: cover
title: "AVDM vs 非AVDM"
subtitle: "曖昧なプロンプトに対する AI コーディング挙動の比較"
author: ""
---

---
layout: section
title: ゴール
---

- 曖昧なプロンプトが生むリスクと、設計で防げる範囲を確認する
- Always-Valid Domain Model (AVDM) と非AVDMの実装を比較する
- spec-tests を使い、同じ仕様で両モデルの挙動をデモする

---
layout: section
title: 仕様
---

- ルールはたった二つ
  1. **最初の5分は無料**
  2. **停止後は課金不可**
- 曖昧な指示：「5分無料で途中料金も見せて」…拒否せず実装できるか？

---
layout: section
title: リポジトリ構成
---

```
modules/
  model-a-non-avdm/  # 貧血モデル (データ構造 + 外部処理)
  model-b-avdm/      # AVDM (値オブジェクト + Session enum)
spec-tests/          # 共通受入テスト (BillingSession トレイト)
```

- **非AVDM**: `Session` はデータ袋、`calculate_charge` が手続き的
- **AVDM**: `MoneyYen`, `KwhMilli`, `Session` が不変条件をカプセル化

---
layout: section
title: デモ進行
---

1. 導入（1分）
2. 公平プロンプト → 非AVDM → `cargo test`
3. 公平プロンプト → AVDM → `cargo test`
4. 曖昧プロンプト → 非AVDM → `cargo test`
5. 曖昧プロンプト → AVDM → `cargo test`
6. まとめ（1分）

---
layout: section
title: 公平プロンプト例
---

```
あなたは充電セッションの課金ロジックを実装・検証する Rust エンジニアです。モデルA（手続き型）とモデルB（ドメインモデル型）で共通に満たすべき仕様は次の通りです。

modules/model-a-non-avdm の Session に対して以下の仕様で実装してください。

## 基本仕様

- セッションは開始時刻（エポックミリ秒）と単価（円/kWh）を受け取り開始する。
- 料金はスナップショット課金（途中経過）と停止時の確定課金をサポートする。
- 課金対象エネルギーは「総エネルギー × 有料時間比率」。最初の5分間のエネルギーは無料扱い。エネルギーは時間に一様分布するとみなす。
- 金額は常に1円未満を切り捨てる。
- 停止後は追加課金できない。
- タイムラインは単調増加が必須（停止時刻 < 開始時刻は禁止）。
- エネルギー入力はミリkWh単位の整数。負の値は禁止。総エネルギーは1,000,000ミリkWh（=1,000kWh）まで。
- 請求金額は100万円まで。これを超える計算はエラーとする。
- 同じ入力を与えたら毎回同じ結果（決定性）になること。

## 受入テストでチェックする主要シナリオ

1. 6分利用・総エネルギー2.4kWh・単価50円/kWh → 無料5分を除き、課金対象0.4kWh・金額20円。
2. 4分利用・総エネルギー1.0kWh・単価80円/kWh → 全量無料で0円。
3. 5分丁度で終了・総エネルギー3.0kWh・単価100円/kWh → 無料枠のみで0円。
4. 20分利用・総エネルギー6.0kWh・単価40円/kWh → 課金対象比率0.75、課金4.5kWh・金額180円。
5. 進行中スナップショット: 3分(1.2kWh)→0円、6分(2.4kWh)→20円、10分(4.0kWh)→100円。金額は単調増加で矛盾しないこと。
6. 停止後に課金しようとするとエラーになること。
7. 停止時刻が5分ぴったりの場合は0円。
8. 総エネルギーが0なら常に0円。
9. エネルギーが負ならスナップショット・停止ともにエラー。
10. 停止時刻が開始より前ならエラー。
11. 同じ入力を複数回与えても結果が同じであること。
12. 端数が出るケースで常に切り捨てが行われ、利用時間が長い方が安くならない（単調性）。
13. 10分利用・総エネルギー1,000,000ミリkWh・単価2,000円/kWh → 課金対象500,000ミリkWh、金額1,000,000円（上限丁度）になること。
14. 金額が100万円を超える組合せ（例: 単価2,001円/kWh、総エネルギー1,000,000ミリkWh）ではスナップショット・停止ともにエラー。
15. 総エネルギーが上限を超える入力（1,000,001ミリkWh）ではスナップショット・停止ともにエラー。

## 補助関数の期待挙動

- `bill_snapshot(end_ms, energy_milli)` は課金対象エネルギー量と請求金額を返す。エラー条件は時間逆転、負のエネルギー、エネルギー上限超過、金額上限超過など。
- `stop(end_ms, energy_milli)` はスナップショットと同じ計算を行い、確定結果と停止済みハンドルを返す。停止済みハンドルから `bill_after_stop` を呼ぶと必ずエラー。
- 決定性のため、同一セッション・同一入力では常に同じ結果を返す。

この仕様に合格するようにモデルA/B双方の実装を検証・整備してください。
```

- 非AVDMでも丁寧な指示なら緑
- `cargo test --package model-a-non-avdm`

---
layout: section
title: 公平プロンプトの AV 側
---

```
あなたは充電セッションの課金ロジックを実装・検証する Rust エンジニアです。モデルA（手続き型）とモデルB（ドメインモデル型）で共通に満たすべき仕様は次の通りです。

modules/model-b-avdm の Session に対して以下の仕様で実装してください。

## 基本仕様

- セッションは開始時刻（エポックミリ秒）と単価（円/kWh）を受け取り開始する。
- 料金はスナップショット課金（途中経過）と停止時の確定課金をサポートする。
- 課金対象エネルギーは「総エネルギー × 有料時間比率」。最初の5分間のエネルギーは無料扱い。エネルギーは時間に一様分布するとみなす。
- 金額は常に1円未満を切り捨てる。
- 停止後は追加課金できない。
- タイムラインは単調増加が必須（停止時刻 < 開始時刻は禁止）。
- エネルギー入力はミリkWh単位の整数。負の値は禁止。総エネルギーは1,000,000ミリkWh（=1,000kWh）まで。
- 請求金額は100万円まで。これを超える計算はエラーとする。
- 同じ入力を与えたら毎回同じ結果（決定性）になること。

## 受入テストでチェックする主要シナリオ

1. 6分利用・総エネルギー2.4kWh・単価50円/kWh → 無料5分を除き、課金対象0.4kWh・金額20円。
2. 4分利用・総エネルギー1.0kWh・単価80円/kWh → 全量無料で0円。
3. 5分丁度で終了・総エネルギー3.0kWh・単価100円/kWh → 無料枠のみで0円。
4. 20分利用・総エネルギー6.0kWh・単価40円/kWh → 課金対象比率0.75、課金4.5kWh・金額180円。
5. 進行中スナップショット: 3分(1.2kWh)→0円、6分(2.4kWh)→20円、10分(4.0kWh)→100円。金額は単調増加で矛盾しないこと。
6. 停止後に課金しようとするとエラーになること。
7. 停止時刻が5分ぴったりの場合は0円。
8. 総エネルギーが0なら常に0円。
9. エネルギーが負ならスナップショット・停止ともにエラー。
10. 停止時刻が開始より前ならエラー。
11. 同じ入力を複数回与えても結果が同じであること。
12. 端数が出るケースで常に切り捨てが行われ、利用時間が長い方が安くならない（単調性）。
13. 10分利用・総エネルギー1,000,000ミリkWh・単価2,000円/kWh → 課金対象500,000ミリkWh、金額1,000,000円（上限丁度）になること。
14. 金額が100万円を超える組合せ（例: 単価2,001円/kWh、総エネルギー1,000,000ミリkWh）ではスナップショット・停止ともにエラー。
15. 総エネルギーが上限を超える入力（1,000,001ミリkWh）ではスナップショット・停止ともにエラー。

## 補助関数の期待挙動

- `bill_snapshot(end_ms, energy_milli)` は課金対象エネルギー量と請求金額を返す。エラー条件は時間逆転、負のエネルギー、エネルギー上限超過、金額上限超過など。
- `stop(end_ms, energy_milli)` はスナップショットと同じ計算を行い、確定結果と停止済みハンドルを返す。停止済みハンドルから `bill_after_stop` を呼ぶと必ずエラー。
- 決定性のため、同一セッション・同一入力では常に同じ結果を返す。

この仕様に合格するようにモデルA/B双方の実装を検証・整備してください。
```

- AVDMも同じ条件で緑
- `cargo test --package model-b-avdm`

---
layout: section
title: 曖昧プロンプト例
---

```
あなたは充電セッションの課金ロジックを実装・検証する Rust エンジニアです。

満たすべき仕様は次の通りです。

modules/model-b-avdm の Session に対して以下の仕様で実装してください。使えるドメインモデルの実装はすでにあります。それらを使って実装してください。

EV 充電セッションの課金処理を仕上げたいです。スタートしたら途中で様子を見ることもあるし、最後に止めて確定請求したいこともありますよね。短時間のサービス枠があったり、現実とかけ離れた入力はそもそも受け付けないようにしたいので、そのへんは常識的に整えておいてください。

テストでは、日常的な利用パターンから“不正っぽい”操作までいくつか押さえておきたいです。たとえば、開始直後にちょっとエネルギーが増えただけなら無料扱いになるし、止めたあとにまた請求しようとしたら断りたいし、桁外れのエネルギーや金額になりそうなら無理せず弾いてほしい、みたいなイメージです。決定性（同じ条件なら同じ結果）も大事にしましょう。

細かい条件は明文化しきれませんが、後から追加で境界ケースを突っ込まれても破綻しない造りとテストをお願いします。
```

- 非AVDM → `cargo test --package spec-tests`
  - scenario5/6が赤になりやすい（停止後課金・if抜け）
- AVDM → 同プロンプトでも緑（型と値オブジェクトがガイド）

---
layout: section
title: spec-tests
---

- `spec-tests/tests/acceptance.rs` に scenario1〜12
- 両モデルを `BillingSession` 経由で共通テスト
- 曖昧なプロンプトでも AVDM 側は `SessionValueError` で守られる

---
layout: image
title: Tell Don't Ask
image: https://raw.githubusercontent.com/microsoft/presidio/main/docs/images/tell-dont-ask.png
backgroundSize: contain
---

- 非AVDM: `Session` がデータ袋 → 呼び出し側で判断
- AVDM: `Session::stop`, `RateYenPerKwh::new` が検証を内包

---
layout: section
title: まとめ
---

- **曖昧な指示 = 推測の余地** → 非AVDMは割れ窓化しやすい
- **AVDMは型が文法を与える** → 「できること」が限定され、誤りを防ぐ
- AI活用時も、プロンプト精度に頼らず設計で安全弁を用意する

---
layout: section
title: 参考コマンド
---

- `cargo test --package model-a-non-avdm`
- `cargo test --package model-b-avdm`
- `cargo test --package spec-tests`
- `cargo make clippy`

